---
title: feapp打包平台
date: 2021-04-29 17:09:17
permalink: /pages/56a025/
categories:
  - 内部文档
  - 发版
tags:
  - 
---

# feapp 打包平台
## 1. 登录  http://gui.ds.gome.com.cn:8080/login#/log/taskBuildLogList（新用户注册地址就可以）
## 2. 代码地址
   - https://code.ds.gome.com.cn/svn/atg_poc/30_Coding/gome-gfe/feapp

## 3. 本地开发
   - 在自己平台安装MongoDB, 参考：https://www.runoob.com/mongodb/mongodb-window-install.html
   - 在mongo的安装目录启动mongo服务,指定mongo 数据存放地址 `mongod.exe --dbpath D:\mongo\data`
   ```
   D:\mongo\bin> mongod.exe --dbpath D:\mongo\data
    当看到就说明服务启动起来了：
    2021-05-08T10:04:05.602+0800 I NETWORK  [thread1] connection accepted from 127.0.0.1:53524 #1 (1 connection now open)
   ```
   - 起接口地址： `npm run server`
   ```
   yijufang@yijufang-GIS MINGW64 /d/GOMEWORK/feapp
  $ npm run server

  > feapp@1.0.0 server D:\GOMEWORK\feapp
  > cross-env NODE_ENV=dev DB_ENV=local nodemon bin/www

  [nodemon] 1.19.1
  [nodemon] reading config .\nodemon.json
  [nodemon] to restart at any time, enter `rs`
  [nodemon] or send SIGHUP to 17480 to restart
  [nodemon] ignoring: build/**/* public/**/*
  [nodemon] watching: *.*
  [nodemon] watching extensions: js,mjs,json
  [nodemon] starting `node bin/www`
  [nodemon] forking
  [nodemon] child pid: 19152
  [nodemon] watching 120 files
  (node:19152) DeprecationWarning: `open()` is deprecated in mongoose >= 4.11.0, use `openUri()` instead, or set the `useMongoClient` option if using `connect()` or `createConnection()`. See http://mongoosejs.com/docs/4.x/docs/connections.html#use-mongo-client
  [2021-05-08 10:11:45.947] [INFO] startup - Listening on  port 8080

   ```
   - 起本地服务： `npm run dev`
   ```
   yijufang@yijufang-GIS MINGW64 /d/GOMEWORK/feapp
  $ npm run dev

  > feapp@1.0.0 dev D:\GOMEWORK\feapp
  > node build/dev-server.js

  [HPM] Proxy created: /api  ->  http://localhost:8080
  [HPM] Proxy created: /dev  ->  http://localhost:8080
  DONE  Compiled successfully in 8966ms10:10:13 AM

  > Listening at http://localhost:8088
  // 浏览器打开http://localhost:8088就可以访问了
   ```
  - 备注： 本地需要备份生产的数据库到本地，这样本地就可以登录和访问接口数据了
  1. 备份生产的数据库feapp-prd 到你的本地d:\mongo\data\feapp
  
```
mongodump --host 10.115.0.146 --username feapp-prd --password feapp-prd --db feapp-prd --authenticationDatabase feapp-prd --out d:\mongo\data\feapp
```

  2. 将生产数据库导入本地数据库feapp-local
```
mongorestore -h 127.0.0.1 -d feapp-local D:\mongo\data\feapp\feapp-prd
```
  - 本地开发完，提交代码后，到jms平台，svn 更新一下代码，然后重启pm2`pm2 restart pm2.json` 就可以
```
[root@VM-10-115-0-146 feapp]# svn update
Updating '.':
U    utils/config/system-config-dev.js
Updated to revision 846378.
```

## 4.服务器地址
   - `10.115.0.146`
   - 登录海燕平台：http://jms.pt.gomedc.com/assets/user-asset/  
   账号域账户登录即可，如果没有服务器的权限，可以问下刘浏怎么开
   - 备份服务器：`10.115.4.19 ` 
   说明：备份服务器是部署组克隆的原服务器，后期如果有这方面需求直接叫部署组克隆，这样的好处是环境不需要自己搭建，只需要克隆完把项目起来就可以。
   - 项目环境相关安装说明
   
```
1.  Mongo安装的基本信息:
(1)所在服务器: 10.115.0.146  
(2)data存放路径：/usr/local/mongodb/data  
(3)log存放路径：/user/local/mongodb/log   
(4)diamon存放地址：/user/local/mongodb/mongo.conf

2.  Feapp库的信息： 
(1)admin库
    Address:10.58.57.5
    Port:27017
    Database:admin
    UserName:admin
    Password:admin  
(2)feapp-prd库
    Address:10.58.57.5
    Port:27017
    Database:feapp-prd
    UserName:feapp-prd
    Password:feapp-prd
(3)feapp-test库
    Address:10.58.57.5
    Port:27017
    Database:feapp-test
    UserName:feapp-test
    Password:feapp-test
3、Mongo的启动与停止：
    (1)启动：mongod -f /usr/local/mongodb/mongo.conf
    (2)停止：netstat -nlp | grep :27017
          kill -2 pid
4、Mongo的数据库授权
    mongodb默认不启用授权认证，只要能连接到该服务器，就可连接到mongod。若要启用安全认证，需要更改配置文件参数auth。
    (1)show dbs;发现没有admin
    (2)use admin;
        db.createUser( 
          { 
            user: "admin", 
            pwd: "admin", 
            roles: [ { role: "root", db: "admin" } ] 
          } 
        )
    (3)show coolections;发现有数据了
    (4)启动auth，停止mongo，/user/local/mongodb/mongo.conf中添加auth=true，启动mongo。
    (5)use admin;
        db.auth('admin','admin');
        如果返回1，表示登录成功
    (6)例如为feapp-prd数据库授权，执行如下命令即可。
        use feapp-prd;
        db.createUser( 
          { 
            user: "feapp-prd", 
            pwd: "feapp-prd", 
            roles: [ { role: "readWrite", db: "feapp-prd" } ] 
          } 
        )
5、数据库备份
mongodump  --host 10.115.0.146:27017 --db feapp-prd --out /feapp-mongodb-bak/feapp-prd-bak-temp/20180202

6、启动mongo : /bin/mongod --dbpath=/usr/local/mongodb/data/db/或/bin/mongod --dbpath=/usr/local/mongodb/data/db/ --logpath=/usr/local/mongodb/log/mongodb.log --logappend --port=27017 --fork
```
## 5. 服务挂了怎么办
- 找部署启动
- 告诉他服务器地址 `10.115.0.146`
- 自己启动

http://gui.ds.gome.com.cn:8080 不能访问的情况，  
pm2 list 发现pm2 没有启动，在webapp/feapp目录启动>pm2 start pm2.json， 
页面可以访问了，但是请求没有，loading 一直转，查看生产数据库是否连接，发现连接不可达，启动mongod数据库
mongod -f /usr/local/mongodb/mongo.conf      (先启动数据库在重启pm2)
![打包平台启动](/img/yjf/feapp-jms.png)

- 监控平台

pm2监控地址：http://gui.ds.gome.com.cn:8088/  密码：AuTh  

安装：npm install pm2-gui -g  
启动：pm2-gui start
## 6. 取包地址
取包地址： http://bin.ds.gome.com.cn/atg_poc/gome-feapp 对应服务器上(10.115.0.146)  

ftp路径：/app/release/atg_poc/gome-feapp/的包地址 
## 6. 日常一些问题
1、部署吧jenkins发版10.58.22.45的地址改成testjk.gome.inc:8080，导致发版失败,我直接更新数据库了
建议安装可视化mongo软件比如：robomongo
```
  db.getCollection('taskmodels').update({'jenkinsPath':'10.58.22.45:8080'},{$set:{'jenkinsPath':'testjk.gome.inc:8080'}},false,true)
```

3、 如果  （10.115.0.146）服务器挂了起不来，打包平台不能用，使用下面备份服务器，启动feapp，

使用http://gui.ds.gome.com.cn:7070/#/task/taskList的地址去打包，
       然后将146的服务找原因恢复，启动feapp ，关闭备份服务器应用）
        备份服务器LOG查看：http://10.115.4.19:7077/auth  密码 AuTh
3.再部署主服务器的时候有一个feapp_test应用http://gui.ds.gome.com.cn:8081/#/log/taskBuildLogList，可以做测试，部署好了之后，然后去部署feapp,打包平台就可以使用了，平时feapp_test没有用


